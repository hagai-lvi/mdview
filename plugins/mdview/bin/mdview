#!/usr/bin/env node

import { existsSync } from 'node:fs';
import { resolve, dirname, basename } from 'node:path';
import { spawn } from 'node:child_process';
import { fileURLToPath } from 'node:url';
import { createServer } from '../lib/server.js';

// Get the directory where this script is located
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Parse command line arguments
const args = process.argv.slice(2);

// Check if file argument is provided
if (args.length === 0) {
  console.error('Usage: mdview <markdown-file>');
  console.error('');
  console.error('A markdown file is required.');
  process.exit(1);
}

const filePath = resolve(args[0]);

// Check if file exists
if (!existsSync(filePath)) {
  console.error(`Error: File not found: ${filePath}`);
  process.exit(1);
}

// Start the server
try {
  const { port } = await createServer(filePath);
  const url = `http://localhost:${port}`;
  console.log(`Server running on ${url}`);

  // Get filename for window title
  const windowTitle = basename(filePath);

  // Path to native viewer binary
  const viewerPath = resolve(__dirname, 'mdview-window');

  // Check if native viewer exists
  if (existsSync(viewerPath)) {
    // Spawn native WebView window
    const viewer = spawn(viewerPath, [url, windowTitle], {
      detached: false,
      stdio: 'ignore'
    });

    viewer.on('close', () => {
      console.log('Viewer closed');
      process.exit(0);
    });

    viewer.on('error', (err) => {
      console.error(`Error launching viewer: ${err.message}`);
      console.log(`Open ${url} in your browser manually`);
    });
  } else {
    // Fallback: open in default browser
    const { default: open } = await import('open');
    console.log(`Native viewer not found. Opening in browser...`);
    await open(url);
    console.log(`Press Ctrl+C to stop the server`);
  }
} catch (err) {
  console.error(`Error starting server: ${err.message}`);
  process.exit(1);
}
